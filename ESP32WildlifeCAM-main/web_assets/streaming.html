<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Wildlife Camera - Live Stream</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        .stream-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        .controls-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        .stream-viewer {
            width: 100%;
            max-width: 640px;
            height: 480px;
            background: #000;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-bottom: 20px;
        }
        .stream-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .settings-group {
            margin-bottom: 20px;
        }
        .settings-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .settings-group select,
        .settings-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status-panel {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online {
            background: #27ae60;
        }
        .status-offline {
            background: #e74c3c;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-box {
            background: white;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¦… ESP32 Wildlife Camera</h1>
            <p>Live Streaming Dashboard</p>
        </div>
        
        <div class="content">
            <div class="stream-section">
                <h2>Live Stream</h2>
                <div class="stream-viewer" id="streamViewer">
                    <div>Stream not active</div>
                </div>
                
                <div class="stream-controls">
                    <button class="btn btn-primary" id="startStreamBtn" onclick="startStream()">
                        Start Stream
                    </button>
                    <button class="btn btn-danger" id="stopStreamBtn" onclick="stopStream()" disabled>
                        Stop Stream
                    </button>
                </div>
                
                <div class="status-panel">
                    <h3>Stream Status</h3>
                    <div class="status-item">
                        <span>
                            <span class="status-indicator status-offline" id="streamIndicator"></span>
                            Connection Status
                        </span>
                        <span id="streamStatus">Offline</span>
                    </div>
                    <div class="status-item">
                        <span>Viewers</span>
                        <span id="viewerCount">0</span>
                    </div>
                    <div class="status-item">
                        <span>Frame Rate</span>
                        <span id="currentFPS">0 FPS</span>
                    </div>
                    <div class="status-item">
                        <span>Quality</span>
                        <span id="currentQuality">Medium</span>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="totalFrames">0</div>
                        <div class="stat-label">Total Frames</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="dataTransferred">0 KB</div>
                        <div class="stat-label">Data Transferred</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="streamDuration">00:00</div>
                        <div class="stat-label">Stream Duration</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="droppedFrames">0</div>
                        <div class="stat-label">Dropped Frames</div>
                    </div>
                </div>
            </div>
            
            <div class="controls-section">
                <h2>Stream Settings</h2>
                
                <div class="settings-group">
                    <label for="frameRate">Frame Rate</label>
                    <select id="frameRate" onchange="updateStreamConfig()">
                        <option value="1">1 FPS</option>
                        <option value="3">3 FPS</option>
                        <option value="5" selected>5 FPS</option>
                        <option value="7">7 FPS</option>
                        <option value="10">10 FPS</option>
                    </select>
                </div>
                
                <div class="settings-group">
                    <label for="quality">Quality</label>
                    <select id="quality" onchange="updateStreamConfig()">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                
                <div class="settings-group">
                    <label for="frameSize">Frame Size</label>
                    <select id="frameSize" onchange="updateStreamConfig()">
                        <option value="qvga">QVGA (320x240)</option>
                        <option value="vga" selected>VGA (640x480)</option>
                        <option value="svga">SVGA (800x600)</option>
                        <option value="hd">HD (1280x720)</option>
                    </select>
                </div>
                
                <div class="settings-group">
                    <label for="motionOnly">
                        <input type="checkbox" id="motionOnly" onchange="updateStreamConfig()">
                        Motion-Only Mode
                    </label>
                </div>
                
                <div class="status-panel">
                    <h3>System Status</h3>
                    <div class="status-item">
                        <span>Battery Level</span>
                        <span id="batteryLevel">--</span>
                    </div>
                    <div class="status-item">
                        <span>Power State</span>
                        <span id="powerState">Normal</span>
                    </div>
                    <div class="status-item">
                        <span>Motion Detected</span>
                        <span id="motionStatus">No</span>
                    </div>
                    <div class="status-item">
                        <span>Memory Free</span>
                        <span id="memoryFree">--</span>
                    </div>
                </div>
                
                <div class="settings-group">
                    <button class="btn btn-primary" onclick="refreshStatus()" style="width: 100%;">
                        Refresh Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let streamActive = false;
        let streamStartTime = 0;
        let statusUpdateInterval = null;

        // Initialize WebSocket connection
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                refreshStatus();
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('Failed to parse WebSocket message:', e);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                setTimeout(initWebSocket, 3000); // Reconnect after 3 seconds
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        // Handle incoming WebSocket messages
        function handleWebSocketMessage(data) {
            if (data.type === 'STREAM_STATUS') {
                updateStreamStatus(data.data);
            } else if (data.type === 'SYSTEM_STATUS') {
                updateSystemStatus(data.data);
            }
        }

        // Start streaming
        function startStream() {
            const fps = document.getElementById('frameRate').value;
            const quality = document.getElementById('quality').value;
            const frameSize = document.getElementById('frameSize').value;
            const motionOnly = document.getElementById('motionOnly').checked;
            
            const params = new URLSearchParams({
                fps: fps,
                quality: quality,
                frameSize: frameSize,
                motionOnly: motionOnly
            });
            
            fetch(`/api/stream/start?${params}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        streamActive = true;
                        streamStartTime = Date.now();
                        updateUI();
                        startStreamViewer();
                        startStatusUpdates();
                    } else {
                        alert('Failed to start stream: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error starting stream:', error);
                    alert('Error starting stream: ' + error.message);
                });
        }

        // Stop streaming
        function stopStream() {
            fetch('/api/stream/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        streamActive = false;
                        updateUI();
                        stopStreamViewer();
                        stopStatusUpdates();
                    } else {
                        alert('Failed to stop stream: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error stopping stream:', error);
                    alert('Error stopping stream: ' + error.message);
                });
        }

        // Update stream configuration
        function updateStreamConfig() {
            if (!streamActive) return;
            
            const fps = document.getElementById('frameRate').value;
            const quality = document.getElementById('quality').value;
            const frameSize = document.getElementById('frameSize').value;
            const motionOnly = document.getElementById('motionOnly').checked;
            
            const params = new URLSearchParams({
                fps: fps,
                quality: quality,
                frameSize: frameSize,
                motionOnly: motionOnly
            });
            
            fetch(`/api/stream/config?${params}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to update config:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error updating config:', error);
                });
        }

        // Start stream viewer (MJPEG)
        function startStreamViewer() {
            const viewer = document.getElementById('streamViewer');
            viewer.innerHTML = '<img id="streamImg" src="/api/stream" style="max-width: 100%; max-height: 100%;" />';
        }

        // Stop stream viewer
        function stopStreamViewer() {
            const viewer = document.getElementById('streamViewer');
            viewer.innerHTML = '<div>Stream not active</div>';
        }

        // Start periodic status updates
        function startStatusUpdates() {
            if (statusUpdateInterval) clearInterval(statusUpdateInterval);
            statusUpdateInterval = setInterval(updateStreamStats, 2000);
        }

        // Stop periodic status updates
        function stopStatusUpdates() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
        }

        // Update stream statistics
        function updateStreamStats() {
            fetch('/api/stream/stats')
                .then(response => response.json())
                .then(data => {
                    updateStreamStatus(data.status);
                    updateStreamStatistics(data.stats);
                })
                .catch(error => {
                    console.error('Error fetching stream stats:', error);
                });
        }

        // Update stream status display
        function updateStreamStatus(status) {
            document.getElementById('streamStatus').textContent = status.streaming ? 'Online' : 'Offline';
            document.getElementById('streamIndicator').className = 
                'status-indicator ' + (status.streaming ? 'status-online' : 'status-offline');
            document.getElementById('viewerCount').textContent = status.clients || 0;
            document.getElementById('currentFPS').textContent = (status.fps || 0) + ' FPS';
            document.getElementById('currentQuality').textContent = status.quality || 'Medium';
            
            if (status.streaming && status.duration) {
                const duration = formatDuration(status.duration);
                document.getElementById('streamDuration').textContent = duration;
            }
        }

        // Update stream statistics
        function updateStreamStatistics(stats) {
            document.getElementById('totalFrames').textContent = stats.totalFrames || 0;
            document.getElementById('dataTransferred').textContent = 
                formatBytes(stats.totalBytes || 0);
            document.getElementById('droppedFrames').textContent = stats.droppedFrames || 0;
        }

        // Update system status
        function updateSystemStatus(system) {
            if (system.battery) {
                document.getElementById('batteryLevel').textContent = 
                    system.battery.percentage + '%';
            }
            if (system.power) {
                const powerStates = ['Critical', 'Low', 'Good', 'Normal'];
                document.getElementById('powerState').textContent = 
                    powerStates[system.power.state] || 'Unknown';
            }
            if (system.memory) {
                document.getElementById('memoryFree').textContent = 
                    formatBytes(system.memory.free);
            }
        }

        // Update UI based on stream state
        function updateUI() {
            document.getElementById('startStreamBtn').disabled = streamActive;
            document.getElementById('stopStreamBtn').disabled = !streamActive;
        }

        // Refresh status manually
        function refreshStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateSystemStatus(data);
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            updateUI();
            refreshStatus();
        });
    </script>
</body>
</html>